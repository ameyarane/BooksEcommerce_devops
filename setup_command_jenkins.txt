# Update all packages
sudo apt update -y
sudo apt upgrade -y


# Install Git
sudo apt install git -y

# Install Ansible
sudo apt install ansible -y

# Set private key permissions (default Ubuntu user is "ubuntu")
chmod 600 /home/ubuntu/.ssh/fqts-demo-key.pem

# List key permissions
ls -l /home/ubuntu/.ssh/fqts-demo-key.pem

wget -q -O - https://pkg.jenkins.io/debian-stable/jenkins.io.key | sudo apt-key add -
sudo apt update

# Import the Microsoft GPG key
curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -

# Add the Microsoft SQL Server tools repository for Ubuntu 22.04 (Jammy)
sudo add-apt-repository "$(curl -s https://packages.microsoft.com/config/ubuntu/22.04/prod.list)"

# Update package lists
sudo apt update

# Install mssql-tools and msodbcsql17
sudo apt install -y mssql-tools msodbcsql17

# (Optional) Check the repo connection
curl -I https://packages.microsoft.com/config/ubuntu/22.04/prod.list
curl -I https://packages.microsoft.com/ubuntu/22.04/prod

# Clean apt cache (optional)
sudo apt clean

# Kill any apt processes (rarely needed, but for troubleshooting)
sudo pkill apt



sudo git clone https://github.com/ameyarane/BooksEcommerce_devops.git


# Move into your project directory
cd BooksEcommerce_devops/


ansible-playbook -i inventory.ini jenkins-setup.yml
ansible-playbook -i inventory.ini jenkins-kubectl-setup.yml


# Add the user 'jenkins' to the 'docker' group
sudo usermod -aG docker jenkins

# Restart the Docker service
sudo systemctl restart docker

Manage Jenkins → Manage Plugins => Install: Docker Pipeline, Amazon ECR, Pipeline, Kubernetes CLI, Credentials Binding Plugin


Step: Configure Jenkins Job for GitHub Webhook
Go to your Jenkins pipeline job.
Click Configure.
Under Build Triggers, check GitHub hook trigger for GITScm polling.
Save.

Step: Add Webhook in GitHub
Go to your GitHub repository (e.g. ameyarane/BooksEcommerce).
Go to Settings → Webhooks → Add webhook.
Payload URL:
http://your-jenkins-server:8080/github-webhook/



kubectl run mssql-tools \
  --rm -it --restart=Never \
  --image=mcr.microsoft.com/mssql-tools \
  -- bash


sqlcmd -S mssql-service -U sa -P 'Cover@2025'


CREATE DATABASE BooksEcommerceDb;
GO
USE BooksEcommerceDb;
GO


CREATE TABLE [dbo].[Books]( [Id] INT IDENTITY(1,1) PRIMARY KEY, [Title] NVARCHAR(MAX) NOT NULL, [Author] NVARCHAR(MAX) NOT NULL, [Price] DECIMAL(18, 2) NOT NULL ); GO



aws eks create-addon \
  --cluster-name books-ecommerce-dev-eks \
  --addon-name aws-ebs-csi-driver \
  --service-account-role-arn arn:aws:iam::949527796968:role/eks-ebs-csi-irsa-role

  
aws eks list-nodegroups --cluster-name books-ecommerce-dev-eks



aws eks describe-nodegroup --cluster-name books-ecommerce-dev-eks --nodegroup-name books-ecommerce-dev-backend-group --query "nodegroup.nodeRole" --output text

kubectl annotate serviceaccount ebs-csi-controller-sa -n kube-system \
  eks.amazonaws.com/role-arn=arn:aws:iam::949527796968:role/eks-ebs-csi-irsa-role --overwrite
  
aws iam list-attached-role-policies --role-name eks-ebs-csi-irsa-role

  
aws configure

aws eks update-kubeconfig --region eu-west-1 --name books-ecommerce-dev-eks
kubectl edit configmap/aws-auth -n kube-system
kubectl get nodes



aws eks describe-cluster --name books-ecommerce-dev-eks --query "cluster.identity.oidc.issuer"



In AWS Console: EKS → Add-ons → Install "Amazon EBS CSI driver".



A. Register OIDC provider via AWS Console (no eksctl needed)
Go to the AWS Console:
IAM → Identity providers → Add provider (top right).

Choose provider type:
OpenID Connect

Provider URL:
Paste your EKS cluster OIDC URL:

https://oidc.eks.eu-west-1.amazonaws.com/id/91778FC014AF2473DBFA54FEEC5A7EAD
Audience:
sts.amazonaws.com

Complete the wizard.
This will register the provider and link it to your account.

B. Register OIDC provider with AWS CLI (no eksctl needed)

	aws iam create-open-id-connect-provider \
	  --url https://oidc.eks.eu-west-1.amazonaws.com/id/91778FC014AF2473DBFA54FEEC5A7EAD \
	  --client-id-list sts.amazonaws.com \
	  --thumbprint-list 9e99a48a9960b14926bb7f3b02e22da0ecd4e9fa





